Job and Queue
=============


## Job

ジョブの実行は、ジョブクラスのインスタンスをディスパッチャに渡す。
ジョブの実行に必要な値はコンストラクタに渡す。
キューに対応するときはシリアライズ化を見越して、フィールドにはスカラー型で持つ方がいい。(コンストラクタに渡すときはオブジェクトでもいいが)

`public function handle()`に、ジョブで実行する処理を書く。
type hintで依存性注入が可能。


## Queue
ジョブクラスに`ShouldQueue`インターフェースを追加し、`Queueable`トレイトも追加する(標準は基底クラスで追加済み)。
ジョブのインスタンスをシリアライズ化して保存、ジョブワーカーがデシリアライズして`handle()`を実行の流れ。

ジョブをキュー実行するジョブワーカーは下記の2通り。

### queue:listen

```
php artisan queue:listen
```

ジョブごとのプロセスで実行する(ジョブごとにフレームワークの起動から)。
ジョブごとに初期化された状態で実行されるので、Webアクセスと似た状態。
グローバル変数・Service Containerの状態を気にしなくて済む感じ。

### queue:work

```
php artisan queue work --daemon
# --daemonをつけないと1ジョブの実行で終了する
```

共通のプロセスでジョブを実行する。フレームワークの起動が1回なので、その分動作が速い。
ただしグローバル変数・Service Containerの状態がジョブ間で共通なので、ジョブ処理の実装に注意が必要。
下手に実装するとメモリリークや意図しない動作に繋がるかも。
ジョブごとのデータベースコネクションの`reconnect()`推奨。
